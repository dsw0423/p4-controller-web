<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P4 Controller</title>
    <link href="./bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .upload-form {
            max-width: 500px;
            margin: 2rem auto;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }

        .file-input-wrapper {
            margin: 1rem 0;
        }

        ul {
            list-style-type: none;
            padding: 0;
        }

        li {
            background: #f8f9fa;
            margin: 5px 0;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        li:hover {
            background: #e9ecef;
        }

        .table-name {
            font-weight: bold;
            color: #333;
        }

        .table-alias {
            color: #6c757d;
        }

        .dropdown {
            margin-top: 10px;
            background: #f1f3f5;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .table-header {
            cursor: pointer;
            padding: 8px;
        }

        .table-header:hover {
            background-color: #f5f5f5;
        }

        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .card {
            background: white;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            padding: 1.5rem;
        }

        .tables-section {
            margin-top: 2rem;
        }

        .upload-form {
            max-width: 100%;
            margin: 0;
            box-shadow: none;
            padding: 0;
        }
    </style>
</head>

<body class="bg-light">
    <nav class="navbar navbar-dark bg-dark">
        <div class="container">
            <span class="navbar-brand">P4 Controller</span>
        </div>
    </nav>

    <div id="app">
        <div v-if="refreshToken" class="main-content">
            <div class="card mb-4">
                <h2 class="mb-4">配置文件列表</h2>
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>文件名</th>
                                <th>上传时间</th>
                                <th>文件大小</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="file in fileList" :key="file.hash">
                                <td>{{ file.fileName }}</td>
                                <td>{{ file.timestamp }}</td>
                                <td>{{ file.size }}B</td>
                                <td>
                                    <button class="btn btn-sm btn-primary me-2" @click="downloadFile(file.hash)">
                                        <i class="bi bi-download"></i> 下载
                                    </button>
                                    <button class="btn btn-sm btn-danger" @click="deleteFile(file.hash)">
                                        <i class="bi bi-trash"></i> 删除
                                    </button>
                                </td>
                            </tr>
                            <tr v-if="fileList.length === 0">
                                <td colspan="4" class="text-center">暂无配置文件</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="row">
                <!-- 左侧上传表单 -->
                <div class="col-md-6">
                    <div class="card">
                        <form @submit.prevent="distributeP4Artifacts" class="upload-form bg-white">
                            <h2 class="mb-4">配置文件下发</h2>

                            <div class="file-input-wrapper">
                                <label class="form-label">P4Info 文件</label>
                                <input class="form-control" type="file" @change="handleP4infoChange">
                            </div>

                            <div class="file-input-wrapper">
                                <label class="form-label">Bin 文件</label>
                                <input class="form-control" type="file" @change="handleBinChange">
                            </div>

                            <button type="submit" class="btn btn-primary w-100 mt-3">
                                <span v-if="isLoading" class="spinner-border spinner-border-sm me-2"></span>
                                提交
                            </button>

                            <div class="alert" :class="distributeMsg.includes('成功') ? 'alert-success' : 'alert-danger'"
                                v-if="distributeMsg" role="alert">
                                {{ distributeMsg }}
                            </div>
                        </form>
                    </div>
                </div>

                <!-- 右侧流表区域 -->
                <div class="col-md-6">
                    <div class="card">
                        <h2>P4流表</h2>
                        <div v-if="p4infoJson && p4infoJson.tables.length > 0">
                            <ul>
                                <li v-for="(table, index) in p4infoJson.tables" :key="index">
                                    <div class="table-header" @click="toggleDropdown(index)">
                                        <span class="table-name">{{ table.preamble.name }}</span>
                                        <span class="table-alias">({{ table.preamble.alias }})</span>
                                    </div>
                                    <!-- 下拉框 -->
                                    <div v-if="expandedIndexes.includes(index)" class="dropdown">
                                        <p>匹配字段:</p>
                                        <ul>
                                            <li v-for="(field, fIndex) in table.match_fields" :key="fIndex">
                                                {{ field.name }} ({{ field.match_type }}, 位宽: {{ field.bitwidth }})
                                            </li>
                                        </ul>

                                        <!-- 新增表项表单 -->
                                        <form @submit.prevent="submitTableEntry(table.preamble.id)">
                                            <div class="mb-3">
                                                <label class="form-label">匹配字段值:</label>
                                                <div v-for="field in table.match_fields" :key="field.name" class="mb-2">
                                                    <label class="form-label">{{ field.name }}:</label>
                                                    <input type="text" class="form-control"
                                                        v-model="tableEntryData[field.name]" required>
                                                </div>
                                            </div>

                                            <div class="mb-3">
                                                <label class="form-label">选择Action:</label>
                                                <select class="form-select" v-model="selectedAction"
                                                    @change="handleActionChange">
                                                    <option value="">请选择Action</option>
                                                    <option v-for="action in table.action_refs" :key="action.id"
                                                        :value="action.id">
                                                        {{ getActionName(action.id) }}
                                                    </option>
                                                </select>
                                            </div>

                                            <div v-if="selectedAction" class="mb-3">
                                                <label class="form-label">Action参数:</label>
                                                <div v-for="param in getActionParams(selectedAction)" :key="param.name"
                                                    class="mb-2">
                                                    <label class="form-label">{{ param.name }} (位宽: {{ param.bitwidth
                                                        }}):</label>
                                                    <input type="text" class="form-control"
                                                        v-model="actionParams[param.name]" required>
                                                </div>
                                            </div>

                                            <button type="submit" class="btn btn-primary">添加表项</button>
                                            <div class="alert"
                                                :class="insertTableEntryMsg.includes('成功') ? 'alert-success' : 'alert-danger'"
                                                v-if="insertTableEntryMsg" role="alert">
                                                {{ insertTableEntryMsg }}
                                            </div>
                                        </form>
                                    </div>
                                </li>
                            </ul>
                        </div>
                        <div v-else>
                            <p>没有找到任何表。</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div v-else class="text-center mt-5">
            <div class="alert alert-warning" role="alert">
                <i class="bi bi-exclamation-triangle me-2"></i>
                未登录，{{ count }} 秒后跳转到登录页面...
            </div>
        </div>
    </div>

    <script type="module">
        import { createApp, ref } from './vue.esm-browser.js';
        import { gotoLogin, checkAuth, serverAddr } from './login.js';
        import { parseP4InfoText } from './utils.js';


        const app = createApp({
            setup() {
                const refreshToken = ref(localStorage.getItem('refreshToken'));
                const count = ref(2);
                const p4info = ref(null);
                const bin = ref(null);
                const distributeMsg = ref('');
                const isLoading = ref(false);
                const p4infoJson = ref(null);
                const expandedIndexes = ref([]);
                const selectedAction = ref('');
                const tableEntryData = ref({});
                const actionParams = ref({});
                const insertTableEntryMsg = ref('');
                const fileList = ref([]);

                const checkTokens = () => {
                    return new Promise((resolve, reject) => {
                        if (refreshToken.value !== null) {
                            checkAuth(refreshToken.value)
                                .then(res => {
                                    const response = res.response;
                                    if (response.hasOwnProperty('accessToken')) {
                                        localStorage.setItem('accessToken', response.accessToken);
                                        console.log('accessToken:', response.accessToken);
                                    }

                                    if (response.hasOwnProperty('refreshToken')) {
                                        localStorage.setItem('refreshToken', response.refreshToken);
                                        console.log('refreshToken:', response.refreshToken);
                                    }
                                    refreshToken.value = localStorage.getItem('refreshToken');
                                    console.log('refreshToken:', refreshToken.value);
                                    resolve(true);
                                })
                                .catch(err => {
                                    console.log(err.error);
                                    localStorage.removeItem('refreshToken');
                                    localStorage.removeItem('accessToken');
                                    refreshToken.value = null;
                                    count.value = 2;
                                    gotoLogin(count);
                                    reject(false);
                                });
                        } else {
                            gotoLogin(count);
                            reject(false);
                        }
                    });
                };

                checkTokens()
                    .then(() => {
                        console.log('tokens refresh ok.');
                        fetchFileList();
                    })
                    .catch(() => {
                        console.log('tokens refresh failed.');
                    });

                const handleP4infoChange = (e) => {
                    p4info.value = e.target.files[0];
                    p4InfoFileToJson(p4info.value);
                };

                const handleBinChange = (e) => {
                    bin.value = e.target.files[0];
                };

                const distributeP4Artifacts = async () => {
                    isLoading.value = true;
                    try {
                        if (!p4info.value || !bin.value) {
                            distributeMsg.value = '未选定P4info或bin文件!';
                            return;
                        }
                        distributeMsg.value = '正在下发...';

                        const formData = new FormData();
                        formData.append('p4info', p4info.value);
                        formData.append('bin', bin.value);

                        let accessToken = localStorage.getItem('accessToken');

                        fetch(serverAddr + '/auth/pipeconf', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${accessToken}`
                            },
                            body: formData
                        })
                            .then(res => {
                                switch (res.status) {
                                    case 200:
                                    case 201:
                                        distributeMsg.value = '下发成功!';
                                        fetchFileList();
                                        break;
                                    case 401:
                                        checkTokens()
                                            .then(() => {
                                                console.log('tokens refresh ok.');
                                                distributeP4Artifacts();
                                            })
                                            .catch(() => {
                                                console.log('tokens refresh failed.');
                                            });
                                        break;
                                    default:
                                        distributeMsg.value = `下发失败! ${res.status}`;

                                }
                                return res.json();
                            })
                            .then(data => {
                                console.log(data.msg);
                            })
                            .catch(err => {
                                console.log(err);
                                distributeMsg.value = '下发失败!';
                            });
                    } finally {
                        isLoading.value = false;
                    }
                };

                const toggleDropdown = (index) => {
                    const i = expandedIndexes.value.indexOf(index);
                    if (i > -1) {
                        expandedIndexes.value.splice(i, 1);
                    } else {
                        expandedIndexes.value.push(index);
                    }
                };

                const p4InfoFileToJson = (file) => {
                    const reader = new FileReader();
                    reader.readAsText(file);
                    reader.onload = (e) => {
                        p4infoJson.value = parseP4InfoText(e.target.result);
                    };
                };

                const getActionName = (actionId) => {
                    const action = p4infoJson.value.actions.find(a => a.preamble.id === actionId);
                    return action ? action.preamble.name : '';
                };

                const getActionParams = (actionId) => {
                    const action = p4infoJson.value.actions.find(a => a.preamble.id === actionId);
                    return action ? action.params : [];
                };

                const handleActionChange = () => {
                    actionParams.value = {};
                };

                const submitTableEntry = async (tableId) => {
                    try {
                        const table = p4infoJson.value.tables.find(t => t.preamble.id === tableId);
                        const tableName = table.preamble.name;

                        const action = p4infoJson.value.actions.find(a => a.preamble.id === selectedAction.value);
                        const actionName = action.preamble.name;

                        const orderedParams = action.params.map(param => actionParams.value[param.name]);

                        const entry = {
                            tableName: tableName,
                            matchField: tableEntryData.value,
                            actionName: actionName,
                            params: orderedParams
                        };

                        console.log('添加的表项:', JSON.stringify(entry, null, 2));
                        let accessToken = localStorage.getItem('accessToken');

                        fetch(serverAddr + '/auth/tableEntryExact', {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${accessToken}`
                            },
                            body: JSON.stringify(entry)
                        })
                            .then(res => {
                                switch (res.status) {
                                    case 200:
                                    case 201:
                                        insertTableEntryMsg.value = '添加表项成功!';
                                        break;
                                    case 401:
                                        checkTokens()
                                            .then(() => {
                                                console.log('tokens refresh ok.');
                                                submitTableEntry(tableId);
                                            })
                                            .catch(() => {
                                                console.log('tokens refresh failed.');
                                            });
                                        break;
                                    default:
                                        insertTableEntryMsg.value = `添加表项失败! ${res.status}`;
                                }
                                return res.json();
                            })
                            .then(data => {
                                console.log(data.msg);
                            })
                            .catch(err => {
                                console.log(err);
                                distributeMsg.value = '下发失败!';
                            });
                    } catch (error) {
                        console.error('Error:', error);
                    }
                };

                const fetchFileList = async () => {
                    try {
                        let accessToken = localStorage.getItem('accessToken');
                        const response = await fetch(serverAddr + '/auth/filesList', {
                            headers: {
                                'Authorization': `Bearer ${accessToken}`
                            }
                        });

                        if (response.status === 401) {
                            await checkTokens();
                            return fetchFileList();
                        }

                        if (response.ok) {
                            const data = await response.json();
                            fileList.value = data || [];
                        }
                    } catch (error) {
                        console.error('Error fetching file list:', error);
                    }
                };

                const downloadFile = async (fileHash) => {
                    try {
                        let accessToken = localStorage.getItem('accessToken');
                        const response = await fetch(`${serverAddr}/auth/file/${fileHash}`, {
                            headers: {
                                'Authorization': `Bearer ${accessToken}`
                            }
                        });

                        if (response.status === 401) {
                            await checkTokens();
                            return downloadFile(fileHash);
                        }

                        if (response.ok) {
                            const contentDisposition = response.headers.get("Content-Disposition");
                            let filename = fileHash; // 默认文件名
                            if (contentDisposition && contentDisposition.includes("filename=")) {
                                filename = contentDisposition
                                    .split("filename=")[1]
                                    .replace(/['"]/g, ""); // 去除可能的引号
                            }

                            const blob = await response.blob();
                            const url = window.URL.createObjectURL(blob);
                            const a = document.createElement('a');
                            a.href = url;
                            a.download = filename;
                            document.body.appendChild(a);
                            a.click();
                            window.URL.revokeObjectURL(url);
                            a.remove();
                        }
                    } catch (error) {
                        console.error('Error downloading file:', error);
                    }
                };

                const deleteFile = async (fileHash) => {
                    if (!confirm('确定要删除此文件吗？')) return;

                    try {
                        let accessToken = localStorage.getItem('accessToken');
                        const response = await fetch(`${serverAddr}/auth/file/${fileHash}`, {
                            method: 'DELETE',
                            headers: {
                                'Authorization': `Bearer ${accessToken}`
                            }
                        });

                        if (response.status === 401) {
                            await checkTokens();
                            return deleteFile(fileHash);
                        }

                        if (response.ok) {
                            await fetchFileList(); // Refresh the list
                        }
                    } catch (error) {
                        console.error('Error deleting file:', error);
                    }
                };

                return {
                    count,
                    refreshToken,
                    handleP4infoChange,
                    handleBinChange,
                    distributeP4Artifacts,
                    distributeMsg,
                    isLoading,
                    p4infoJson,
                    expandedIndexes,
                    toggleDropdown,
                    selectedAction,
                    tableEntryData,
                    actionParams,
                    getActionName,
                    getActionParams,
                    handleActionChange,
                    submitTableEntry,
                    insertTableEntryMsg,
                    fileList,
                    downloadFile,
                    deleteFile
                };
            }
        });

        app.mount('#app');
    </script>
</body>

</html>